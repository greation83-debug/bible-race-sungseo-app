<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²œë¡œì—­ì • ì„±ê²½ ë ˆì´ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .bg-stripes-gray { background-image: linear-gradient(135deg, #e2e8f0 25%, transparent 25%, transparent 50%, #e2e8f0 50%, #e2e8f0 75%, transparent 75%, transparent); background-size: 10px 10px; }
        /* í•˜ëŠ˜ ë°°ê²½ */
        .bg-sky-texture { 
            background: linear-gradient(to bottom, #bae6fd 0%, #f0f9ff 100%);
        }
        @keyframes wiggle { 0%, 100% { transform: rotate(-3deg) scale(1.1); } 50% { transform: rotate(3deg) scale(1.1); } }
        .animate-wiggle { animation: wiggle 0.3s ease-in-out infinite; }
        .animate-float { animation: float 6s ease-in-out infinite; }
        .animate-float-slow { animation: float 10s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateX(0px); } 50% { transform: translateX(10px); } 100% { transform: translateX(0px); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ì‚° ë°°ê²½ ì¥ì‹ (CSS Draw) */
        .mountain-back {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60%;
            background: #86efac; /* ì—°í•œ ì´ˆë¡ */
            clip-path: polygon(0% 100%, 0% 40%, 15% 70%, 30% 20%, 50% 60%, 70% 30%, 85% 50%, 100% 20%, 100% 100%);
            z-index: 1;
            opacity: 0.8;
        }
        .mountain-front {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45%;
            background: #4ade80; /* ì§„í•œ ì´ˆë¡ */
            clip-path: polygon(0% 100%, 0% 80%, 20% 50%, 40% 90%, 60% 60%, 80% 80%, 100% 50%, 100% 100%);
            z-index: 2;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        // ====================================================================
        // [ìˆ˜ì •ë¨] ë…¸ì…˜ í‚¤ ì‚­ì œ -> Supabase ì„œë²„ ì£¼ì†Œ ì…ë ¥ë€ìœ¼ë¡œ ë³€ê²½
        // ë‚˜ì¤‘ì— Supabaseì— ë°°í¬í•˜ê³  ë‚˜ì˜¨ ì£¼ì†Œë¥¼ ì•„ë˜ ë”°ì˜´í‘œ ì•ˆì— ë„£ìœ¼ì„¸ìš”.
        // ì˜ˆ: "https://abcdefg.supabase.co/functions/v1/notion-proxy"
        // ====================================================================
        const SUPABASE_FUNCTION_URL = "https://mvwhepqqzdtqtorgkrtf.supabase.co/functions/v1/notion-proxy";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        let db, auth;
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            }
        } catch (e) { console.error("Firebase init failed:", e); }

        // --- ì•„ì´ì½˜ ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                crown: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7zm5 16h10"/></svg>,
                trophy: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
                users: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
                book: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>,
                arrowRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
                mapPin: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
                back: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>,
                check: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
                flame: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>,
                info: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
                close: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
                trash: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                download: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
                refresh: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
                edit: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
                helpbook: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            };
            return icons[name] || null;
        };

        const LEVEL_SYSTEM = [
            { min: 0, title: 'ì‘ì•  ë‚˜ ì•„ê¸° ì„±ë„', emoji: 'ğŸ¼' },
            { min: 30, title: 'ì„¤êµ ë•Œ ê¿€ì ìëŠ” ìœ ë‘ê³ ', emoji: 'ğŸ˜´' },
            { min: 100, title: 'í˜•ë“¤ ë„ì‹œë½ ë°°ë‹¬í•˜ëŠ” ë‹¤ìœ—', emoji: 'ğŸ±' },
            { min: 200, title: 'ì˜ˆìˆ˜ë‹˜ ë³´ë ¤ê³  ë‚˜ë¬´ íƒ„ ì‚­ê°œì˜¤', emoji: 'ğŸŒ³' },
            { min: 350, title: 'ëŒë§¹ì´ë¡œ ê³¨ë¦¬ì•— ì¡ì€ ìš©ì‚¬', emoji: 'ğŸª¨' },
            { min: 550, title: 'ì‚¬ì ë°¥ ë  ë»”í•œ ë‹¤ë‹ˆì—˜', emoji: 'ğŸ¦' },
            { min: 800, title: 'ì§€íŒ¡ì´ë¡œ í™í•´ ê°€ë¥¸ ëª¨ì„¸', emoji: 'ğŸŒŠ' },
            { min: 1200, title: 'ë¶ˆë³‘ê±° íƒ€ê³  ìŠ¹ì²œí•˜ëŠ” ì—˜ë¦¬ì•¼', emoji: 'ğŸ”¥' }
        ];

        // --- í”Œëœ ë° ë²„ì „ ë°ì´í„° ---
        const PLAN_TYPES = [
            { id: '1year', title: 'ì¼ë…„ ì¼ë…', desc: '1ë…„ì— ì„±ê²½ 1ë…ì„ í•©ë‹ˆë‹¤.' },
            { id: 'nt', title: 'ì‹ ì•½ ì¼ë…', desc: '1ë…„ ë™ì•ˆ ì‹ ì•½ 1ë…ì„ í•©ë‹ˆë‹¤.' }
        ];

        const BIBLE_VERSIONS = {
            '1year': [
                { id: 'revised', name: 'ê°œì—­ê°œì •', desc: 'êµíšŒì—ì„œ í‰ì†Œì— ì‚¬ìš©í•˜ëŠ” ì„±ê²½', tagName: 'ê°œì—­ê°œì • ì¼ë…„ì¼ë…' },
                { id: 'new', name: 'ìƒˆë²ˆì—­', desc: 'ì‰¬ìš´ í˜„ëŒ€ì–´ë¡œ ì½ì„ ìˆ˜ ìˆëŠ” ì„±ê²½', tagName: 'ìƒˆë²ˆì—­ ì¼ë…„ì¼ë…' },
                { id: 'easy', name: 'ì‰¬ìš´ì„±ê²½', desc: 'ì–´ë¦°ì´ë„ ì‰½ê²Œ ì½ì„ ìˆ˜ ìˆëŠ” ì„±ê²½', tagName: 'ì‰¬ìš´ì„±ê²½ ì¼ë…„ì¼ë…' }
            ],
            'nt': [
                { id: 'new', name: 'ìƒˆë²ˆì—­', desc: 'ì‰¬ìš´ í˜„ëŒ€ì–´ë¡œ ì½ì„ ìˆ˜ ìˆëŠ” ì„±ê²½', tagName: 'ìƒˆë²ˆì—­ ì‹ ì•½ì¼ë…' },
                { id: 'easy', name: 'ì‰¬ìš´ì„±ê²½', desc: 'ì–´ë¦°ì´ë„ ì‰½ê²Œ ì½ì„ ìˆ˜ ìˆëŠ” ì„±ê²½', tagName: 'ì‰¬ìš´ì„±ê²½ ì‹ ì•½ì¼ë…' },
                { id: 'message', name: 'ë©”ì‹œì§€ ì„±ê²½', desc: 'í˜„ëŒ€ ë¬¸í™”ì™€ ì¼ìƒ ì–¸ì–´ë¡œ ìƒìƒí•˜ê²Œ ì¬í•´ì„í•œ ì˜ì—­ ì„±ê²½', tagName: 'ë©”ì‹œì§€ ì‹ ì•½ì¼ë…' }
            ]
        };

        const seniorSubgroups = Array.from({length: 14}, (_, i) => `${i + 1}êµ¬ì—­`).concat(['ì—¬ì„±ì‹¤ë²„1', 'ì—¬ì„±ì‹¤ë²„2', 'ë‚¨ìì‹¤ë²„', 'ì Šì€ë¶€ë¶€']);
        const youthSubgroups = ['ìœ ë¦¬ ëª©ì¥', 'ì•„ì˜ ëª©ì¥', 'í™”ëª© ëª©ì¥', 'ë¯¼í˜ ëª©ì¥'];
        const middleHighSubgroups = ['1ëª©ì¥', '2ëª©ì¥', '3ëª©ì¥', '4ëª©ì¥'];
        const elementarySubgroups = ['1í•™ë…„', '2í•™ë…„', '3í•™ë…„', '4í•™ë…„', '5í•™ë…„', '6í•™ë…„'];
        const kindergartenSubgroups = ['ì†Œë§ë°˜', 'ë¹Œë¦½ë°˜', 'ë¯¿ìŒë°˜'];

        const MOCK_COMMUNITIES = [
          { id: 'senior', name: 'ì¥ë…„ë¶€', avgDay: 82, color: 'bg-orange-500', icon: 'ğŸ”ï¸', subgroups: seniorSubgroups },
          { id: 'youth', name: 'ì²­ë…„ë¶€', avgDay: 45, color: 'bg-blue-500', icon: 'ğŸƒ', subgroups: youthSubgroups },
          { id: 'middlehigh', name: 'ì¤‘ê³ ë“±ë¶€', avgDay: 30, color: 'bg-purple-500', icon: 'ğŸ«', subgroups: middleHighSubgroups },
          { id: 'elementary', name: 'ìœ ì´ˆë“±ë¶€', avgDay: 20, color: 'bg-yellow-500', icon: 'ğŸ¥', subgroups: elementarySubgroups },
          { id: 'kinder', name: 'ìœ ì•„ìœ ì¹˜ë¶€', avgDay: 10, color: 'bg-pink-500', icon: 'ğŸ¼', subgroups: kindergartenSubgroups },
        ];

        const GHOST_RUNNERS = [
          { name: 'ê¹€ì² ìˆ˜', day: 42, score: 450, gender: 'male' },
          { name: 'ì´ì˜í¬', day: 48, score: 560, gender: 'female' },
          { name: 'ë°•ëª©ì‚¬', day: 90, score: 1300, gender: 'male' },
          { name: 'ìµœì§‘ì‚¬', day: 15, score: 80, gender: 'female' },
        ];

        const TOTAL_DAYS = 365;
        const PANIC_DISTANCE = 5;

        // ì°½ì„¸ê¸° 1ì¥ ì „ì²´ í…ìŠ¤íŠ¸ (ë°ëª¨ìš©)
        const GENESIS_1 = `### 1. íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼
2. ë•…ì´ í˜¼ëˆí•˜ê³  ê³µí—ˆí•˜ë©° í‘ì•”ì´ ê¹ŠìŒ ìœ„ì— ìˆê³  í•˜ë‚˜ë‹˜ì˜ ì˜ì€ ìˆ˜ë©´ ìœ„ì— ìš´í–‰í•˜ì‹œë‹ˆë¼
3. í•˜ë‚˜ë‹˜ì´ ì´ë¥´ì‹œë˜ ë¹›ì´ ìˆìœ¼ë¼ í•˜ì‹œë‹ˆ ë¹›ì´ ìˆì—ˆê³ 
4. ë¹›ì´ í•˜ë‚˜ë‹˜ì´ ë³´ì‹œê¸°ì— ì¢‹ì•˜ë”ë¼ í•˜ë‚˜ë‹˜ì´ ë¹›ê³¼ ì–´ë‘ ì„ ë‚˜ëˆ„ì‚¬
(ì¤‘ëµ)`;

        // --- Markdown Renderer ---
        const MarkdownRenderer = ({ content }) => {
            if (!content) return null;
            const lines = content.split('\n');
            return (
                <div className="space-y-4">
                    {lines.map((line, i) => {
                        const trimmed = line.trim();
                        if (trimmed.startsWith('### ')) return <h3 key={i} className="text-lg font-bold text-slate-800 mt-4 mb-2 border-b border-slate-200 pb-1">{trimmed.slice(4)}</h3>;
                        if (trimmed.startsWith('## ')) return <h2 key={i} className="text-xl font-bold text-slate-800 mt-5 mb-2">{trimmed.slice(3)}</h2>;
                        if (trimmed.startsWith('# ')) return <h1 key={i} className="text-2xl font-bold text-slate-800 mt-6 mb-3">{trimmed.slice(2)}</h1>;
                        if (trimmed.startsWith('â€¢ ') || trimmed.startsWith('- ')) return <li key={i} className="list-disc list-inside ml-4 text-slate-700 font-serif">{trimmed.slice(2)}</li>;
                        if (/^\d+\.\s/.test(trimmed)) return <li key={i} className="list-decimal list-inside ml-4 text-slate-700 font-serif">{trimmed.replace(/^\d+\.\s/, '')}</li>;
                        if (trimmed.startsWith('> ')) return <blockquote key={i} className="border-l-4 border-blue-300 pl-4 italic text-slate-600 my-4 bg-slate-50 p-2 rounded font-serif">{trimmed.slice(2)}</blockquote>;
                        if (trimmed === '') return <div key={i} className="h-2"></div>;
                        return <p key={i} className="text-slate-700 leading-relaxed font-serif text-lg">{line}</p>;
                    })}
                </div>
            );
        };

        // --- Main Component ---
        const App = () => {
            const [view, setView] = React.useState('login'); 
            const [loginName, setLoginName] = React.useState('');
            const [loginPw, setLoginPw] = React.useState('');
            const [tempUser, setTempUser] = React.useState(null); 
            const [currentUser, setCurrentUser] = React.useState(null); 
            const [errorMsg, setErrorMsg] = React.useState('');
            const [showConfetti, setShowConfetti] = React.useState(false);
            const [levelUpToast, setLevelUpToast] = React.useState(null);
            const [subgroupStats, setSubgroupStats] = React.useState({});
            const [verseData, setVerseData] = React.useState({ title: '', subtitle: '', text: '', loading: false });
            const [hasReadToday, setHasReadToday] = React.useState(false);
            const [showScoreInfo, setShowScoreInfo] = React.useState(false);
            const [showReadingGuide, setShowReadingGuide] = React.useState(false); 
            const [bonusToast, setBonusToast] = React.useState(null);
            
            const [selectedPlanType, setSelectedPlanType] = React.useState(null);

            const [isAdmin, setIsAdmin] = React.useState(false);
            const [allUsers, setAllUsers] = React.useState([]);
            const [editingUser, setEditingUser] = React.useState(null); 

            const getLevelInfo = (score) => {
                const level = [...LEVEL_SYSTEM].reverse().find(l => score >= l.min) || LEVEL_SYSTEM[0];
                return level;
            };

            const downloadCSV = () => {
                if (allUsers.length === 0) {
                    alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
                csvContent += "ì´ë¦„,ë¶€ì„œ,ì†Œê·¸ë£¹,í˜„ì¬Day,ì´ì ìˆ˜,ì—°ì†ì¼ìˆ˜,ë§ˆì§€ë§‰ì½ì€ë‚ ,í”ŒëœID\n";
                allUsers.forEach(u => {
                    const row = `${u.name},${u.communityName},${u.subgroupId},${u.currentDay},${u.score},${u.streak},${u.lastReadDate || 'ì—†ìŒ'},${u.planId || '1year_revised'}`;
                    csvContent += row + "\r\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `ì„±ê²½í†µë…_ì „ì²´ê¸°ë¡_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const deleteUser = (userName) => {
                if (confirm(`${userName}ë‹˜ì˜ ë°ì´í„°ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    localStorage.removeItem(`user_${userName}`);
                    setAllUsers(prev => prev.filter(u => u.name !== userName));
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            };

            const startEditUser = (user) => {
                setEditingUser({ ...user });
            };

            const saveEditUser = () => {
                if (!editingUser) return;
                localStorage.setItem(`user_${editingUser.name}`, JSON.stringify(editingUser));
                setAllUsers(prev => prev.map(u => u.name === editingUser.name ? editingUser : u));
                setEditingUser(null);
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleLogin = (e) => {
                e.preventDefault();
                setErrorMsg('');
                if(!loginName.trim() || !loginPw.trim()) {
                    setErrorMsg("ì´ë¦„ê³¼ ì•”í˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (loginName === 'admin' && loginPw === '08283') {
                    const users = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('user_')) {
                            try { users.push(JSON.parse(localStorage.getItem(key))); } catch(e) {}
                        }
                    }
                    setAllUsers(users);
                    setIsAdmin(true);
                    return;
                }
                const userKey = `user_${loginName.trim()}`;
                const storedUser = localStorage.getItem(userKey);
                if (storedUser) {
                    const parsedUser = JSON.parse(storedUser);
                    if (parsedUser.password === loginPw) {
                        if (!parsedUser.startDate) {
                            parsedUser.startDate = new Date().toDateString();
                            localStorage.setItem(userKey, JSON.stringify(parsedUser));
                        }
                        if (parsedUser.score === undefined) parsedUser.score = parsedUser.currentDay * 10;
                        setCurrentUser(parsedUser);
                        const todayStr = new Date().toDateString();
                        setHasReadToday(parsedUser.lastReadDate === todayStr);
                        setView('dashboard');
                    } else {
                        setErrorMsg("ì•”í˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                    }
                } else {
                    const newUserBase = {
                        name: loginName.trim(),
                        password: loginPw,
                        startDate: new Date().toDateString(), 
                        currentDay: 1,
                        streak: 0,
                        score: 0, 
                        lastReadDate: null,
                        gender: Math.random() > 0.5 ? 'male' : 'female',
                    };
                    setTempUser(newUserBase);
                    setTempUser(prev => ({...newUserBase})); // Ensure clean slate
                    setView('plan_type_select'); 
                }
            };

            const handlePlanTypeSelect = (typeId) => {
                setSelectedPlanType(typeId);
                setView('bible_version_select');
            };

            const handleVersionSelect = (versionId) => {
                const fullPlanId = `${selectedPlanType}_${versionId}`;
                if (tempUser) {
                    setTempUser(prev => ({ ...prev, planId: fullPlanId }));
                    setView('community_select');
                } 
                else if (currentUser) {
                    const updatedUser = { ...currentUser, planId: fullPlanId };
                    setCurrentUser(updatedUser);
                    localStorage.setItem(`user_${updatedUser.name}`, JSON.stringify(updatedUser));
                    setView('dashboard');
                    setShowConfetti(true); 
                    setTimeout(() => setShowConfetti(false), 2000);
                }
            };

            const handleCommunitySelect = (commId, commName) => {
                setTempUser(prev => ({ ...prev, communityId: commId, communityName: commName }));
                setView('subgroup_select');
            };

            const handleSubgroupSelect = (subgroup) => {
                const finalUser = { ...tempUser, subgroupId: subgroup };
                const userKey = `user_${finalUser.name}`;
                localStorage.setItem(userKey, JSON.stringify(finalUser));
                setCurrentUser(finalUser);
                setTempUser(null); // Clear tempUser after signup
                setView('dashboard');
            };

            // --- [ìˆ˜ì •ëœ ë¶€ë¶„] Supabase Edge Function í˜¸ì¶œ ë¡œì§ ---
            const fetchNotionData = async (planId, currentDay) => {
                if (!SUPABASE_FUNCTION_URL || SUPABASE_FUNCTION_URL.includes("YOUR_")) {
                    console.warn("Supabase URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    return { title: null, text: "ì„œë²„ ì—°ê²° ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”." };
                }

                const [planType, version] = (planId || '1year_revised').split('_');
                const targetTag = BIBLE_VERSIONS[planType]?.find(v => v.id === version)?.tagName || 'ê°œì—­ê°œì • ì¼ë…„ì¼ë…';
                
                // ì˜¤ëŠ˜ ë‚ ì§œ ë§¤ì¹­ (ë…„ë„ ë¬´ì‹œ, 2025ë…„ ê¸°ì¤€ ì›”/ì¼)
                const targetDate = new Date(2025, 0, currentDay); 
                const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
                const dd = String(targetDate.getDate()).padStart(2, '0');
                const targetDateStr = `${mm}-${dd}`;
                
                console.log(`Requesting Server: Tag=[${targetTag}], Date=[${targetDateStr}]`);

                try {
                    // ë‚´ ì„œë²„(Supabase)ì— "ì´ íƒœê·¸ì™€ ì´ ë‚ ì§œì˜ ê¸€ì„ ì¤˜"ë¼ê³  ìš”ì²­
                    const response = await fetch(SUPABASE_FUNCTION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            tag: targetTag,
                            date: targetDateStr
                        })
                    });

                    if (!response.ok) throw new Error(`Server Error: ${response.status}`);
                    const data = await response.json();
                    
                    if (data.error) return { title: null, text: `[ì˜¤ë¥˜] ${data.error}` };
                    
                    // ì„œë²„ê°€ ë‹¤ ì²˜ë¦¬í•´ì„œ titleê³¼ textë§Œ ê¹”ë”í•˜ê²Œ ì¤ë‹ˆë‹¤.
                    return { title: data.title, text: data.text };

                } catch (e) {
                    console.error("Fetch Error:", e);
                    return { title: null, text: "ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”." };
                }
            };

            React.useEffect(() => {
                if (view !== 'dashboard' || !currentUser) return;

                const loadVerse = async () => {
                    setVerseData(prev => ({ ...prev, loading: true }));
                    const { currentDay, planId } = currentUser;
                    const [planType, version] = (planId || '1year_revised').split('_');
                    const planTypeName = PLAN_TYPES.find(p => p.id === planType)?.title || 'ì„±ê²½ í†µë…';
                    
                    const notionData = await fetchNotionData(planId, currentDay);
                    
                    if (notionData && notionData.text && !notionData.text.startsWith('[ì˜¤ë¥˜]')) {
                        setVerseData({ 
                            title: `${planTypeName} DAY ${currentDay}ì¼`,
                            subtitle: notionData.title || `(ì œëª© ì—†ìŒ)`,
                            text: notionData.text, 
                            loading: false 
                        });
                    } else {
                        const versionName = BIBLE_VERSIONS[planType]?.find(v => v.id === version)?.name || 'ê¸°ë³¸';
                        // ë°ëª¨ ëª¨ë“œ (1ì¼ì°¨ëŠ” ë³´ì—¬ì¤Œ, ì„œë²„ ì˜¤ë¥˜ ì‹œì—ë„ ì°½ì„¸ê¸° 1ì¥ ì˜ˆì‹œ)
                        const isFirstDay = currentDay === 1;
                        const hasError = !notionData || notionData.text.includes('ì˜¤ë¥˜') || notionData.text.includes('ì„œë²„');
                        
                        let displayText;
                        if (isFirstDay && hasError) {
                            displayText = GENESIS_1; // 1ì¼ì°¨ì¸ë° ì„œë²„ ì•ˆ ë˜ë©´ ì¼ë‹¨ ì°½ì„¸ê¸° ë³´ì—¬ì¤Œ
                        } else {
                            displayText = notionData?.text || `ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n1. ë…¸ì…˜ ì—°ë™ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.\n2. '${versionName}' íƒœê·¸ê°€ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”.\n3. ì˜¤ëŠ˜ ë‚ ì§œì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`;
                        }

                        setTimeout(() => {
                            setVerseData({ 
                                title: `${planTypeName} DAY ${currentDay}ì¼`, 
                                subtitle: `${versionName} ì½ê¸°`,
                                text: displayText,
                                loading: false 
                            });
                        }, 500);
                    }
                };

                loadVerse();

                const comm = MOCK_COMMUNITIES.find(c => c.id === currentUser.communityId);
                if (comm) {
                    const stats = {};
                    comm.subgroups.forEach(sub => {
                        let rate = Math.floor(Math.random() * 50) + 30;
                        stats[sub] = rate;
                    });
                    if (!hasReadToday) {
                        stats[currentUser.subgroupId] = Math.max(0, stats[currentUser.subgroupId] - 5);
                    }
                    setSubgroupStats(stats);
                }

            }, [view, currentUser?.currentDay, currentUser?.planId]);

            const handleRead = () => {
                const todayStr = new Date().toDateString();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();

                let newStreak = currentUser.streak || 0;
                if (currentUser.lastReadDate === yesterdayStr) {
                    newStreak += 1;
                } else if (currentUser.lastReadDate !== todayStr) {
                    newStreak = 1;
                }
                
                const streakBonus = Math.min(newStreak, 5);
                const pointsEarned = 10 + streakBonus;
                const newScore = (currentUser.score || 0) + pointsEarned;
                
                const oldLevel = getLevelInfo(currentUser.score || 0);
                const newLevel = getLevelInfo(newScore);
                
                if (newLevel.min > oldLevel.min) {
                    setLevelUpToast(newLevel);
                    setTimeout(() => setLevelUpToast(null), 4000);
                }

                setBonusToast({ basic: 10, streak: streakBonus, total: pointsEarned });
                setTimeout(() => setBonusToast(null), 4000);

                const newDay = currentUser.currentDay + 1;
                const updatedUser = { 
                    ...currentUser, 
                    currentDay: newDay, 
                    streak: newStreak,
                    score: newScore,
                    lastReadDate: todayStr 
                };
                
                setCurrentUser(updatedUser);
                setHasReadToday(true);
                localStorage.setItem(`user_${currentUser.name}`, JSON.stringify(updatedUser));
                
                setShowConfetti(true);
                setTimeout(() => setShowConfetti(false), 3000);
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setIsAdmin(false);
                setTempUser(null);
                setLoginName('');
                setLoginPw('');
                setErrorMsg('');
                setView('login');
                setHasReadToday(false);
                setEditingUser(null);
            };

            const handleChangeVersionStart = () => {
                setSelectedPlanType(null); 
                setTempUser(null); 
                setView('plan_type_select');
            };

            const getSubgroupRanking = () => {
                if (!currentUser || !subgroupStats) return [];
                const currentStats = { ...subgroupStats };
                if (hasReadToday) {
                    currentStats[currentUser.subgroupId] = Math.min(100, currentStats[currentUser.subgroupId] + 5);
                }
                return Object.entries(currentStats)
                    .map(([name, rate]) => ({ name, rate }))
                    .sort((a, b) => b.rate - a.rate);
            };

            // ================= VIEW RENDERING =================

            // ê´€ë¦¬ì ëª¨ë“œ
            if (isAdmin) {
                return (
                    <div className="min-h-screen bg-slate-100 p-6">
                        <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h1 className="text-2xl font-bold text-slate-800">ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ</h1>
                                <button onClick={handleLogout} className="text-sm bg-slate-200 px-3 py-2 rounded hover:bg-slate-300">ë‚˜ê°€ê¸°</button>
                            </div>
                            
                            <div className="mb-6 flex gap-2">
                                <button onClick={downloadCSV} className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-bold">
                                    <Icon name="download" size={18}/> ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ
                                </button>
                                <div className="text-xs text-slate-500 flex items-center bg-slate-50 px-2 rounded">
                                    * ì „ì²´ ì½ì€ ê¸°ë¡ì„ ì—‘ì…€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
                                </div>
                            </div>

                            {/* ìœ ì € ìˆ˜ì • ëª¨ë‹¬ */}
                            {editingUser && (
                                <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                                    <div className="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl space-y-4">
                                        <h3 className="font-bold text-lg border-b pb-2">íšŒì› ì •ë³´ ìˆ˜ì • ({editingUser.name})</h3>
                                        
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">ì†Œì† ê³µë™ì²´</label>
                                            <select 
                                                value={editingUser.communityId} 
                                                onChange={e => {
                                                    const comm = MOCK_COMMUNITIES.find(c => c.id === e.target.value);
                                                    setEditingUser({
                                                        ...editingUser, 
                                                        communityId: comm.id, 
                                                        communityName: comm.name,
                                                        subgroupId: comm.subgroups[0] 
                                                    });
                                                }}
                                                className="w-full border rounded p-2 text-sm"
                                            >
                                                {MOCK_COMMUNITIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">ì†Œê·¸ë£¹</label>
                                            <select 
                                                value={editingUser.subgroupId} 
                                                onChange={e => setEditingUser({...editingUser, subgroupId: e.target.value})}
                                                className="w-full border rounded p-2 text-sm"
                                            >
                                                {MOCK_COMMUNITIES.find(c => c.id === editingUser.communityId)?.subgroups.map(s => (
                                                    <option key={s} value={s}>{s}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">ì„±ê²½ ì½ê¸° í”Œëœ</label>
                                            <select 
                                                value={editingUser.planId || '1year_revised'} 
                                                onChange={e => setEditingUser({...editingUser, planId: e.target.value})}
                                                className="w-full border rounded p-2 text-sm"
                                            >
                                                <optgroup label="ì¼ë…„ ì¼ë…">
                                                    {BIBLE_VERSIONS['1year'].map(v => <option key={`1year_${v.id}`} value={`1year_${v.id}`}>{v.name}</option>)}
                                                </optgroup>
                                                <optgroup label="ì‹ ì•½ ì¼ë…">
                                                    {BIBLE_VERSIONS['nt'].map(v => <option key={`nt_${v.id}`} value={`nt_${v.id}`}>{v.name}</option>)}
                                                </optgroup>
                                            </select>
                                        </div>

                                        <div className="flex gap-2 pt-4">
                                            <button onClick={saveEditUser} className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">ì €ì¥</button>
                                            <button onClick={() => setEditingUser(null)} className="flex-1 bg-slate-200 text-slate-600 py-2 rounded hover:bg-slate-300">ì·¨ì†Œ</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-600">
                                    <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                        <tr>
                                            <th className="px-4 py-3">ì´ë¦„</th>
                                            <th className="px-4 py-3">ë¶€ì„œ / ì†Œê·¸ë£¹</th>
                                            <th className="px-4 py-3 text-center">ì•”í˜¸</th>
                                            <th className="px-4 py-3 text-center">Day</th>
                                            <th className="px-4 py-3 text-center">ì ìˆ˜</th>
                                            <th className="px-4 py-3 text-center">í”Œëœ</th>
                                            <th className="px-4 py-3 text-center">ê´€ë¦¬</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {allUsers.length > 0 ? allUsers.map((u, idx) => (
                                            <tr key={idx} className="border-b hover:bg-slate-50">
                                                <td className="px-4 py-3 font-medium text-slate-900">{u.name}</td>
                                                <td className="px-4 py-3">
                                                    <span className="font-bold">{u.communityName}</span><br/>
                                                    <span className="text-xs text-slate-400">{u.subgroupId}</span>
                                                </td>
                                                <td className="px-4 py-3 text-center text-slate-400">{u.password}</td>
                                                <td className="px-4 py-3 text-center font-bold text-blue-600">{u.currentDay}</td>
                                                <td className="px-4 py-3 text-center">{u.score}</td>
                                                <td className="px-4 py-3 text-center text-xs text-slate-400 truncate max-w-[100px]">{u.planId}</td>
                                                <td className="px-4 py-3 text-center">
                                                    <div className="flex justify-center gap-2">
                                                        <button onClick={() => startEditUser(u)} className="text-blue-500 hover:text-blue-700 p-1 bg-blue-50 rounded">
                                                            <Icon name="edit" size={16} />
                                                        </button>
                                                        <button onClick={() => deleteUser(u.name)} className="text-red-500 hover:text-red-700 p-1 bg-red-50 rounded">
                                                            <Icon name="trash" size={16} />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="7" className="px-4 py-6 text-center text-slate-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'login') {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6 relative">
                        <div className="absolute top-4 right-4">
                            <button onClick={() => { setLoginName('admin'); setLoginPw(''); document.querySelector('input[type=password]').focus(); }} 
                                className="text-xs text-slate-300 hover:text-slate-500">ê´€ë¦¬ì</button>
                        </div>

                        <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border border-slate-100">
                            <div className="text-center mb-8">
                                <div className="text-4xl mb-2">ğŸƒâ€â™‚ï¸ğŸ’¨</div>
                                <h1 className="text-2xl font-extrabold text-slate-800">ì²œë¡œì—­ì • ì„±ê²½ ë ˆì´ìŠ¤</h1>
                                <p className="text-slate-400 text-sm mt-2">ìœ ì¾Œí•œ ì‹ ì•™ìƒí™œì˜ ì‹œì‘!</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">ì´ë¦„</label>
                                    <input type="text" value={loginName} onChange={e => setLoginName(e.target.value)} 
                                        className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="í™ê¸¸ë™" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">ì•”í˜¸</label>
                                    <input type="password" value={loginPw} onChange={e => setLoginPw(e.target.value)} 
                                        className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="1ê¸€ìë„ ê°€ëŠ¥í•´ìš”" />
                                </div>
                                
                                <div className="bg-red-50 p-3 rounded-lg border border-red-100">
                                    <p className="text-xs text-red-600 font-bold break-keep text-center">
                                        âš ï¸ ì²˜ìŒ ì˜¤ì…¨ë‚˜ìš”? <br/>
                                        ë°˜ë“œì‹œ <span className="underline">ì‹¤ëª…</span>ìœ¼ë¡œ ê°€ì…í•´ì£¼ì„¸ìš”.<br/>
                                        (ì˜ˆ: í™ê¸¸ë™)
                                    </p>
                                </div>

                                {errorMsg && <p className="text-red-500 text-xs text-center">{errorMsg}</p>}
                                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95 mt-4">
                                    ì…ì¥í•˜ê¸°
                                </button>

                                <p className="text-xs text-slate-400 text-center mt-3">
                                    ì•”í˜¸ë¥¼ ìŠì–´ë²„ë¦° ê²½ìš° ì‚¬ë¬´ì‹¤ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.
                                </p>
                            </form>
                        </div>
                    </div>
                );
            }

            if (view === 'plan_type_select') {
                return (
                    <div className="min-h-screen bg-slate-50 p-6 flex flex-col items-center justify-center">
                        <div className="w-full max-w-md mb-6">
                            {/* ì„¤ì • ë³€ê²½ ì¤‘ì´ë¼ë©´ ë’¤ë¡œê°€ê¸° = ëŒ€ì‹œë³´ë“œ */}
                            {currentUser && !tempUser && (
                                <button onClick={() => setView('dashboard')} className="text-sm text-slate-400 flex items-center hover:text-slate-600 mb-4">
                                    <Icon name="back" size={16} className="mr-1"/> ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                                </button>
                            )}
                            <h2 className="text-xl font-bold text-slate-800 text-center">
                                {currentUser && !tempUser ? "ì½ëŠ” ë²„ì „ ë°”ê¾¸ê¸°" : `í™˜ì˜í•©ë‹ˆë‹¤, ${tempUser.name}ë‹˜!`}
                            </h2>
                            <p className="text-slate-500 text-sm text-center mt-1">ì–´ë–¤ ê³„íšìœ¼ë¡œ ì½ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        </div>
                        
                        <div className="w-full max-w-md space-y-3">
                            {PLAN_TYPES.map(type => (
                                <button key={type.id} onClick={() => handlePlanTypeSelect(type.id)}
                                    className="w-full bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:border-blue-500 hover:bg-blue-50 transition-all text-left">
                                    <div className="font-bold text-slate-800 text-lg mb-1">{type.title}</div>
                                    <div className="text-xs text-slate-400">{type.desc}</div>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (view === 'bible_version_select') {
                const versions = BIBLE_VERSIONS[selectedPlanType];
                const planTitle = PLAN_TYPES.find(t => t.id === selectedPlanType)?.title;

                return (
                    <div className="min-h-screen bg-slate-50 p-6 flex flex-col items-center justify-center">
                        <div className="w-full max-w-md">
                            <button onClick={() => setView('plan_type_select')} className="text-sm text-slate-400 flex items-center hover:text-slate-600 mb-4">
                                <Icon name="back" size={16} className="mr-1"/> ë’¤ë¡œê°€ê¸°
                            </button>
                            <div className="text-center mb-6">
                                <h2 className="text-xl font-bold text-slate-800">{planTitle} ë²„ì „ ì„ íƒ</h2>
                                <div className="bg-yellow-50 text-yellow-800 text-xs font-bold p-2 rounded-lg mt-2 break-keep">
                                    ğŸ“¢ ì˜¤ëŠ˜ ì„¤ì •í•˜ì‹œë©´ ê¸°ë³¸ì ìœ¼ë¡œ 1ë…„ê°„ ì´ ë²„ì „ìœ¼ë¡œ ì½ê²Œ ë©ë‹ˆë‹¤.
                                </div>
                            </div>
                        </div>
                        
                        <div className="w-full max-w-md space-y-3">
                            {versions.map(ver => (
                                <button key={ver.id} onClick={() => handleVersionSelect(ver.id)}
                                    className="w-full bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:border-blue-500 hover:bg-blue-50 transition-all text-left">
                                    <div className="font-bold text-slate-800 text-lg mb-1">{ver.name}</div>
                                    <div className="text-xs text-slate-400">{ver.desc}</div>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (view === 'community_select') {
                return (
                    <div className="min-h-screen bg-slate-50 p-6 flex flex-col items-center justify-center">
                        <div className="text-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800">ì†Œì† ê³µë™ì²´ ì„ íƒ</h2>
                            <p className="text-slate-500 text-sm">ì–´ëŠ ë¶€ì„œì— ì†Œì†ë˜ì–´ ê³„ì‹ ê°€ìš”?</p>
                        </div>
                        <div className="w-full max-w-md space-y-3">
                            {MOCK_COMMUNITIES.map(comm => (
                                <button key={comm.id} onClick={() => handleCommunitySelect(comm.id, comm.name)}
                                    className="w-full bg-white p-4 rounded-2xl shadow-sm border border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center gap-4 text-left">
                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl ${comm.color.replace('bg-', 'bg-opacity-10 text-')}`}>
                                        {comm.icon}
                                    </div>
                                    <div className="flex-1">
                                        <div className="font-bold text-slate-800 text-lg">{comm.name}</div>
                                    </div>
                                    <Icon name="arrowRight" className="text-slate-300"/>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (view === 'subgroup_select') {
                const selectedComm = MOCK_COMMUNITIES.find(c => c.id === tempUser.communityId);
                return (
                    <div className="min-h-screen bg-slate-50 p-6 flex flex-col items-center justify-center">
                        <div className="w-full max-w-md mb-4">
                            <button onClick={() => setView('community_select')} className="text-sm text-slate-400 flex items-center hover:text-slate-600">
                                <Icon name="back" size={16} className="mr-1"/> ë’¤ë¡œê°€ê¸°
                            </button>
                        </div>
                        <div className="text-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800">ì†Œê·¸ë£¹ ì„ íƒ</h2>
                            <p className="text-slate-500 text-sm">{tempUser.communityName} ë‚´ì˜ ì†Œê·¸ë£¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                        </div>
                        <div className="w-full max-w-md grid grid-cols-2 gap-3 h-[50vh] overflow-y-auto content-start">
                            {selectedComm.subgroups.map((sub, idx) => (
                                <button key={idx} onClick={() => handleSubgroupSelect(sub)}
                                    className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all text-center flex flex-col items-center justify-center aspect-video">
                                    <span className="text-2xl mb-2 opacity-80">ğŸ•ï¸</span>
                                    <span className="font-bold text-slate-700 text-sm">{sub}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (view === 'dashboard' && currentUser) {
                const { currentDay, score, subgroupId, communityName, planId, streak } = currentUser;
                const [planType, version] = (planId || '1year_revised').split('_');
                const planTypeName = PLAN_TYPES.find(p => p.id === planType)?.title || 'ì„±ê²½ í†µë…';
                const versionName = BIBLE_VERSIONS[planType]?.find(v => v.id === version)?.name || '';

                const myLevel = getLevelInfo(score || 0);

                const progressPercent = Math.min((currentDay / TOTAL_DAYS) * 100, 100);
                const closestChaserDistance = GHOST_RUNNERS
                    .filter(r => r.day < currentDay)
                    .reduce((minDist, r) => Math.min(minDist, currentDay - r.day), Infinity);
                const isPanic = closestChaserDistance <= PANIC_DISTANCE;
                
                // [ë³€ê²½] ì™„ë…ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜ ê³„ì‚°
                const daysRemaining = Math.max(0, TOTAL_DAYS - currentDay);

                const racers = [
                    ...GHOST_RUNNERS.map(r => ({ ...r, isMe: false })), 
                    { name: currentUser.name, day: currentDay, score: score, isMe: true, isPanic: isPanic }
                ].sort((a, b) => a.day - b.day);
                
                const subgroupRanking = getSubgroupRanking();
                
                const topGroups = subgroupRanking.slice(0, 3);
                const myGroupStats = subgroupRanking.find(r => r.name === subgroupId) || { name: subgroupId, rate: 0 };
                const isMyGroupInTop3 = topGroups.some(g => g.name === subgroupId);

                return (
                    <div className="min-h-screen bg-slate-50 pb-20 overflow-hidden relative font-sans">
                        {showConfetti && <div className="fixed inset-0 z-50 flex justify-center pt-40 pointer-events-none"><div className="text-6xl animate-bounce">ğŸŠ</div></div>}
                        
                        {levelUpToast && (
                            <div className="fixed top-20 left-4 right-4 z-50 animate-bounce">
                                <div className="bg-slate-900 text-white p-4 rounded-2xl shadow-2xl flex items-center gap-3">
                                    <div className="text-3xl">{levelUpToast.emoji}</div>
                                    <div>
                                        <p className="text-xs text-yellow-400 font-bold">LEVEL UP!</p>
                                        <p className="font-bold">{levelUpToast.title}(ìœ¼)ë¡œ ìŠ¹ê¸‰!</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {bonusToast && (
                            <div className="fixed top-24 left-1/2 transform -translate-x-1/2 z-50 animate-fade-in-up">
                                <div className="bg-blue-600 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 font-bold whitespace-nowrap">
                                    <span>ê¸°ë³¸ 10ì </span>
                                    <span>+</span>
                                    <span>ì—°ì†ë³´ë„ˆìŠ¤ {bonusToast.streak}ì </span>
                                    <span>=</span>
                                    <span className="text-yellow-300">ì´ {bonusToast.total}ì  íšë“!</span>
                                </div>
                            </div>
                        )}

                        {showScoreInfo && (
                            <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4" onClick={() => setShowScoreInfo(false)}>
                                <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <h3 className="text-xl font-bold">ğŸ’¡ ì ìˆ˜ & ê³„ê¸‰ ì•ˆë‚´</h3>
                                        <button onClick={() => setShowScoreInfo(false)} className="text-slate-400"><Icon name="close"/></button>
                                    </div>
                                    <div className="space-y-4 overflow-y-auto max-h-[60vh]">
                                        <div className="bg-slate-50 p-3 rounded-xl border border-slate-100 mb-2">
                                            <h4 className="font-bold text-slate-800 mb-1">ğŸ“– ì²œë¡œì—­ì • ì„±ê²½ ë ˆì´ìŠ¤ë€?</h4>
                                            <p className="text-xs text-slate-600 leading-relaxed">
                                                ìˆœë¡€ìê°€ ì²œêµ­ì„ í–¥í•´ ê±¸ì–´ê°€ë“¯, ìš°ë¦¬ë„ ë§¤ì¼ ë§ì”€ì„ ì½ìœ¼ë©° ì˜ì ì¸ ëª©ì ì§€ë¥¼ í–¥í•´ ë‚˜ì•„ê°€ëŠ” ë ˆì´ìŠ¤ì…ë‹ˆë‹¤.<br/>
                                                ë‚˜ í˜¼ì ê±·ëŠ” ê¸¸ì´ ì•„ë‹ˆë¼, ìš°ë¦¬ ê³µë™ì²´(êµ¬ì—­/ëª©ì¥)ê°€ í•¨ê»˜ ê²©ë ¤í•˜ë©° ì™„ì£¼í•˜ëŠ” ê¸°ì¨ì„ ëˆ„ë ¤ë³´ì„¸ìš”!
                                            </p>
                                        </div>

                                        <div>
                                            <h4 className="font-bold text-blue-600 mb-1">ë‚˜ì˜ ë“±ê¸‰</h4>
                                            <div className="flex items-center gap-3 bg-blue-50 p-3 rounded-xl border border-blue-100">
                                                <div className="text-3xl">{myLevel.emoji}</div>
                                                <div>
                                                    <div className="font-bold text-lg">{myLevel.title}</div>
                                                    <div className="text-xs text-slate-500">í˜„ì¬ {score}ì </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-slate-700 mb-1">ì ìˆ˜ ëª¨ìœ¼ëŠ” ë²•</h4>
                                            <ul className="text-sm text-slate-600 space-y-1 list-disc pl-4">
                                                <li>ë§¤ì¼ ì½ê¸° ì™„ë£Œ: <strong>+10ì </strong></li>
                                                <li>ì—°ì† ì½ê¸° ë³´ë„ˆìŠ¤: <strong>ë§¤ì¼ +1ì ì”© ì¦ê°€ (ìµœëŒ€ +5ì  ìœ ì§€)</strong><br/>
                                                    <span className="text-xs text-red-500">* í•˜ë£¨ë¼ë„ ë¹ ì§€ë©´ ë‹¤ì‹œ +1ì ë¶€í„° ì‹œì‘í•´ìš”!</span>
                                                </li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-slate-700 mb-1">ì²œë¡œì—­ì • ê³„ê¸‰í‘œ</h4>
                                            <div className="grid gap-2 text-sm">
                                                {LEVEL_SYSTEM.map((lvl, idx) => (
                                                    <div key={idx} className={`flex items-center gap-2 p-2 rounded ${lvl.title === myLevel.title ? 'bg-yellow-50 border border-yellow-200' : ''}`}>
                                                        <span className="text-xl">{lvl.emoji}</span>
                                                        <span className="flex-1">{lvl.title}</span>
                                                        <span className="text-slate-400 text-xs">{lvl.min}pt~</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={() => setShowScoreInfo(false)} className="w-full bg-slate-100 font-bold py-3 rounded-xl mt-4 text-slate-600">ë‹«ê¸°</button>
                                </div>
                            </div>
                        )}

                        {/* ì„±ê²½í†µë… 114 ì•ˆë‚´ ëª¨ë‹¬ [NEW] ìƒì„¸í™” */}
                        {showReadingGuide && (
                            <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4" onClick={() => setShowReadingGuide(false)}>
                                <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <h3 className="text-xl font-bold text-slate-800">ğŸ“– ì„±ê²½í†µë… 114 ê°€ì´ë“œ</h3>
                                        <button onClick={() => setShowReadingGuide(false)} className="text-slate-400"><Icon name="close"/></button>
                                    </div>
                                    <div className="space-y-6 text-sm text-slate-600 leading-relaxed overflow-y-auto max-h-[60vh] pr-2">
                                        
                                        {/* ì„¹ì…˜ 1: 114ì˜ ì˜ë¯¸ */}
                                        <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                            <h4 className="font-bold text-blue-700 mb-1">ğŸ’¡ ì„±ê²½í†µë… 114ë€?</h4>
                                            <p className="text-xs mb-2">
                                                <strong>1ë…„ 1ë… 4íšŒ íš¨ê³¼!</strong><br/>
                                                ì„±ê²½ ì „ì²´ë¥¼ 1ë…„ì— 1ë²ˆ í†µë…í•˜ì§€ë§Œ, 3ê°œì›”(í•œ ë¶„ê¸°)ë§ˆë‹¤ ì„±ê²½ ì „ì²´ ì‹œëŒ€ë¥¼ ë³¼ ìˆ˜ ìˆë„ë¡ ë˜ì–´ ìˆìœ¼ë©°, ì¤‘ë³µëœ ì‹œëŒ€ë¥¼ ë‚˜ëˆ„ì–´ ì½ì–´ ì§€ë£¨í•˜ì§€ ì•Šê²Œ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                            </p>
                                        </div>

                                        {/* ì„¹ì…˜ 2: ë¶„ê¸°ë³„ ì½ê¸° ìˆœì„œ (ìƒì„¸ í’€ë„¤ì„) */}
                                        <div>
                                            <h4 className="font-bold text-slate-800 mb-2 border-b border-slate-200 pb-1">ğŸ“… ë¶„ê¸°ë³„ ì½ê¸°</h4>
                                            <div className="space-y-3 text-xs">
                                                <div className="bg-green-50 p-2 rounded">
                                                    <span className="font-bold text-green-700 block mb-1">1ë¶„ê¸° (1-3ì›”)</span>
                                                    <span className="block text-slate-500 mb-1"><strong>êµ¬ì•½:</strong> ì°½ì„¸ê¸° 1-11ì¥, ì¶œì• êµ½ê¸°, ì—¬í˜¸ìˆ˜ì•„, ì‚¬ì‚¬ê¸°, ë£»ê¸°, ìš¥ê¸°, ë‹¤ë‹ˆì—˜, ì—ìŠ¤ë¼ 1-6ì¥, í•™ê°œ, ìŠ¤ê°€ë´, ì—ìŠ¤ë¼ 7-10ì¥, ëŠí—¤ë¯¸ì•¼, ì—ìŠ¤ë”</span>
                                                    <span className="block text-slate-500"><strong>ì‹ ì•½:</strong> ë§ˆíƒœë³µìŒ, ì‚¬ë„í–‰ì „ 1-5ì¥, ë¡œë§ˆì„œ, ê°ˆë¼ë””ì•„ì„œ, íˆë¸Œë¦¬ì„œ, ìš”í•œê³„ì‹œë¡ 1-3ì¥</span>
                                                </div>
                                                <div className="bg-green-50 p-2 rounded">
                                                    <span className="font-bold text-green-700 block mb-1">2ë¶„ê¸° (4-6ì›”)</span>
                                                    <span className="block text-slate-500 mb-1"><strong>êµ¬ì•½:</strong> ì°½ì„¸ê¸° 12-26ì¥, ë ˆìœ„ê¸°, ì‚¬ë¬´ì—˜ìƒ, ì‚¬ë¬´ì—˜í•˜, ì‹œí¸ 1-72í¸, ì´ì‚¬ì•¼, ìš”ì—˜, ì˜¤ë°”ëŒœ, ë‚˜í›”, í•˜ë°•êµ­</span>
                                                    <span className="block text-slate-500"><strong>ì‹ ì•½:</strong> ë§ˆê°€ë³µìŒ, ì‚¬ë„í–‰ì „ 6-12ì¥, ê³ ë¦°ë„ì „ì„œ, ê³ ë¦°ë„í›„ì„œ, ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ, ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ, ì•¼ê³ ë³´ì„œ, ìœ ë‹¤ì„œ, ìš”í•œê³„ì‹œë¡ 4-7ì¥</span>
                                                </div>
                                                <div className="bg-green-50 p-2 rounded">
                                                    <span className="font-bold text-green-700 block mb-1">3ë¶„ê¸° (7-9ì›”)</span>
                                                    <span className="block text-slate-500 mb-1"><strong>êµ¬ì•½:</strong> ì°½ì„¸ê¸° 27-36ì¥, ë¯¼ìˆ˜ê¸°, ì—´ì™•ê¸°ìƒ 1-11ì¥, ì ì–¸, ì „ë„ì„œ, ì•„ê°€ì„œ, ì—´ì™•ê¸°ìƒ 12-22ì¥, ì—´ì™•ê¸°í•˜ 1-14ì¥, ìš”ë‚˜, ì—´ì™•ê¸°í•˜ 15ì¥, ì•„ëª¨ìŠ¤, í˜¸ì„¸ì•„, ì—´ì™•ê¸°í•˜ 16-23ì¥, ìŠ¤ë°”ëƒ, ì—´ì™•ê¸°í•˜ 24-25ì¥, ì—ìŠ¤ê²”</span>
                                                    <span className="block text-slate-500"><strong>ì‹ ì•½:</strong> ëˆ„ê°€ë³µìŒ, ì‚¬ë„í–‰ì „ 13-20ì¥, ì—ë² ì†Œì„œ, ë¹Œë¦½ë³´ì„œ, ê³¨ë¡œìƒˆì„œ, ë¹Œë ˆëª¬ì„œ, ë² ë“œë¡œì „ì„œ, ë² ë“œë¡œí›„ì„œ, ìš”í•œê³„ì‹œë¡ 8-14ì¥</span>
                                                </div>
                                                <div className="bg-green-50 p-2 rounded">
                                                    <span className="font-bold text-green-700 block mb-1">4ë¶„ê¸° (10-12ì›”)</span>
                                                    <span className="block text-slate-500 mb-1"><strong>êµ¬ì•½:</strong> ì°½ì„¸ê¸° 37-50ì¥, ì‹ ëª…ê¸°, ì‹œí¸ 90í¸, ì—­ëŒ€ìƒ, ì‹œí¸ 73-150í¸, ì—­ëŒ€í•˜ 1-28ì¥, ë¯¸ê°€, ì—­ëŒ€í•˜ 29-36ì¥, ì˜ˆë ˆë¯¸ì•¼, ì˜ˆë ˆë¯¸ì•¼ì• ê°€, ë§ë¼ê¸°</span>
                                                    <span className="block text-slate-500"><strong>ì‹ ì•½:</strong> ìš”í•œë³µìŒ, ì‚¬ë„í–‰ì „ 21-28ì¥, ë””ëª¨ë°ì „ì„œ, ë””ëª¨ë°í›„ì„œ, ë””ë„ì„œ, ìš”í•œì¼ì„œ, ìš”í•œì´ì„œ, ìš”í•œì‚¼ì„œ, ìš”í•œê³„ì‹œë¡ 15-22ì¥</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={() => setShowReadingGuide(false)} className="w-full bg-slate-100 font-bold py-3 rounded-xl mt-4 text-slate-600">ë‹«ê¸°</button>
                                </div>
                            </div>
                        )}

                        <div className="bg-slate-900 text-slate-300 text-[10px] py-1 px-4 flex justify-between items-center">
                            <span>í˜„ì¬ ë²„ì „: <strong>{planTypeName} - {versionName}</strong></span>
                            <button onClick={handleChangeVersionStart} className="flex items-center gap-1 hover:text-white transition-colors">
                                <Icon name="refresh" size={10} /> ì½ëŠ” ë²„ì „ ë°”ê¾¸ê¸°
                            </button>
                        </div>

                        <header className="bg-white shadow-sm border-b border-slate-100 pb-2 sticky top-0 z-30">
                            <div className="px-4 py-2 flex justify-between items-center border-b border-slate-50">
                                <button onClick={handleLogout} className="text-xs font-bold text-slate-400 flex items-center hover:text-slate-600">
                                    <Icon name="back" size={12} className="mr-1"/> ë¡œê·¸ì•„ì›ƒ
                                </button>
                                <div className="flex items-center gap-2">
                                    <div className={`text-xs font-bold px-2 py-1 rounded-lg flex items-center gap-1 ${streak > 0 ? 'bg-orange-50 text-orange-600' : 'bg-slate-100 text-slate-400'}`}>
                                        <Icon name="flame" size={12} className={streak > 0 ? "fill-orange-500 text-orange-600" : ""}/>
                                        {streak}ì¼
                                    </div>
                                    <div className="flex items-center gap-1">
                                        <button onClick={() => setShowScoreInfo(true)} className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg flex items-center gap-1 hover:bg-blue-100 transition-colors">
                                            {myLevel.emoji} {score || 0}pt <span className="bg-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] border border-blue-200">?</span>
                                        </button>
                                        <button onClick={() => setShowReadingGuide(true)} className="text-xs font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded-lg flex items-center gap-1 hover:bg-slate-200 transition-colors">
                                            <Icon name="helpbook" size={14} className="text-slate-500"/>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-slate-50 px-4 py-4 border-b border-slate-200">
                                <div className="flex justify-between items-end mb-3">
                                    <span className="text-sm font-bold text-slate-700 flex items-center gap-1">
                                        ğŸ† {communityName} ì‹¤ì‹œê°„ ë­í‚¹
                                    </span>
                                    {/* ëª¨ë°”ì¼ ìµœì í™”: ê¸´ í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ ë° ìŠ¤íƒ€ì¼ ê°œì„  */}
                                    <span className="text-[10px] text-slate-400 shrink-0">ë§¤ì¼ ë¦¬ì…‹</span>
                                </div>
                                <div className="space-y-3">
                                    {topGroups.map((group, idx) => {
                                        const isMyGroup = group.name === subgroupId;
                                        const rankColor = idx === 0 ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : 
                                                          idx === 1 ? 'bg-slate-200 text-slate-700 border-slate-300' :
                                                          'bg-orange-100 text-orange-700 border-orange-200';
                                        const barColor = idx === 0 ? 'bg-yellow-400' : idx === 1 ? 'bg-slate-400' : 'bg-orange-400';
                                        
                                        return (
                                            <div key={idx} className="flex items-center gap-3">
                                                <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold border shrink-0 ${rankColor}`}>
                                                    {idx + 1}
                                                </div>
                                                <div className="flex-1 min-w-0"> {/* min-w-0 for flex child truncation */}
                                                    <div className="flex justify-between text-[10px] mb-1">
                                                        <span className={`font-bold truncate pr-2 ${isMyGroup ? 'text-blue-600' : 'text-slate-600'}`}>
                                                            {group.name} {isMyGroup && '(ë‚˜)'}
                                                        </span>
                                                        <span className="font-bold text-slate-500 shrink-0">{group.rate}%</span>
                                                    </div>
                                                    <div className="h-3 w-full bg-white rounded-full overflow-hidden border border-slate-100 relative">
                                                        {/* [ëª¨ë°”ì¼ ê°€ë…ì„±] í…ìŠ¤íŠ¸ ê·¸ë¦¼ì ì¶”ê°€ */}
                                                        <div className={`h-full rounded-full ${barColor}`} style={{ width: `${group.rate}%` }}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    
                                    {!isMyGroupInTop3 && (
                                        <div className="flex items-center gap-3 mt-2 pt-2 border-t border-slate-200 border-dashed">
                                            <div className="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold bg-blue-100 text-blue-700 border border-blue-200 shrink-0">
                                                ?
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex justify-between text-[10px] mb-1">
                                                    <span className="font-bold text-blue-600 truncate pr-2">{myGroupStats.name} (ë‚˜)</span>
                                                    <span className="font-bold text-slate-500 shrink-0">{myGroupStats.rate}%</span>
                                                </div>
                                                <div className="h-3 w-full bg-white rounded-full overflow-hidden border border-slate-100">
                                                    <div className="h-full rounded-full bg-blue-500" style={{ width: `${myGroupStats.rate}%` }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* [ê°•í™”ëœ] ê°œì¸ ë ˆì´ìŠ¤ íŠ¸ë™ ë””ìì¸ (CSS Draw Only) */}
                            <div className="relative w-full h-28 bg-map-texture overflow-hidden mt-0 border-t border-slate-200 bg-sky-texture">
                                <div className="mountain-back"></div>
                                <div className="mountain-front"></div>
                                
                                <div className="absolute top-2 left-10 text-2xl opacity-80 animate-float">â˜ï¸</div>
                                <div className="absolute top-5 right-20 text-xl opacity-60 animate-float-slow">â˜ï¸</div>
                                <div className="absolute top-8 left-1/2 text-lg opacity-50 animate-float" style={{animationDelay: '2s'}}>â˜ï¸</div>

                                <div className="absolute bottom-2 left-5 text-sm z-10 opacity-90">ğŸŒ¸</div>
                                <div className="absolute bottom-3 right-10 text-sm z-10 opacity-90">ğŸŒ¼</div>
                                <div className="absolute bottom-4 left-1/3 text-xs z-10 opacity-80">ğŸŒ±</div>

                                <div className="absolute right-2 top-1/2 -translate-y-1/2 flex flex-col justify-center items-center z-20 group" style={{top: '60%'}}>
                                    <div className="relative">
                                        <div className="absolute inset-0 bg-yellow-400 rounded-full blur-xl opacity-70 group-hover:opacity-100 transition-opacity animate-pulse"></div>
                                        <div className="absolute inset-0 bg-white rounded-full blur-md opacity-50 animate-ping"></div>
                                        <span className="text-5xl relative z-10 drop-shadow-2xl filter brightness-110">ğŸ°</span>
                                    </div>
                                    <span className="text-[9px] font-bold text-slate-600 bg-white/90 px-2 py-0.5 rounded-full mt-2 shadow-sm border border-slate-200 relative z-20">ì²œêµ­ì„±</span>
                                </div>
                                
                                {racers.map((racer, idx) => {
                                    const p = Math.min((racer.day / TOTAL_DAYS) * 100, 100);
                                    const isMe = racer.isMe;
                                    const racerLevel = getLevelInfo(racer.score || 0);
                                    
                                    return (
                                        <div key={idx} className="absolute transition-all duration-1000 ease-out flex flex-col items-center"
                                            style={{ left: `calc(${p}% - 16px)`, top: isMe ? '50%' : `${40+(idx%3)*10}%`, zIndex: isMe ? 50 : idx + 20 }}>
                                            <div className={`text-[9px] px-1.5 py-0.5 rounded-full mb-1 shadow-sm font-bold truncate max-w-[80px] ${isMe ? 'bg-blue-600 text-white' : 'bg-white/90 text-slate-500'}`}>
                                                {racer.name}
                                            </div>
                                            <div className={`w-9 h-9 rounded-full flex items-center justify-center text-xl shadow-md border-[3px] transition-transform bg-white ${isMe ? `border-blue-400 ${racer.isPanic ? 'animate-wiggle':''}` : 'border-white opacity-80 grayscale'}`}>
                                                {racer.isPanic && isMe ? 'ğŸ˜±' : racerLevel.emoji}
                                                {racer.isPanic && isMe && <span className="absolute -top-1 -right-1 text-sm animate-ping">ğŸ’¦</span>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            <div className="bg-white border-b border-slate-100 py-1 text-center">
                                <button onClick={() => setShowScoreInfo(true)} className="text-xs text-slate-500 flex items-center justify-center gap-1 mx-auto hover:text-blue-600">
                                    í˜„ì¬ ë‚˜ì˜ ë“±ê¸‰: <span className="font-bold text-slate-800">{myLevel.emoji} {myLevel.title}</span> (í´ë¦­í•˜ì—¬ í™•ì¸)
                                </button>
                            </div>
                        </header>

                        <main className="px-4 py-6 max-w-md mx-auto space-y-8">
                            <div className="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
                                <div className={`p-6 text-white relative ${isPanic ? 'bg-gradient-to-br from-red-500 to-orange-600' : 'bg-gradient-to-br from-indigo-600 to-blue-700'}`}>
                                    {/* ì™„ë… D-Day ë°°ì§€ [NEW] */}
                                    <div className="absolute top-4 right-4 bg-white/20 backdrop-blur-md text-white border border-white/30 text-xs font-bold px-3 py-1 rounded-full shadow-sm">
                                        ğŸ ì™„ë… D-{daysRemaining}
                                    </div>
                                    
                                    <h2 className="text-xl font-bold mb-1">{verseData.loading ? 'ë¡œë”©ì¤‘...' : verseData.title}</h2>
                                    <p className="opacity-90 text-sm font-bold text-white/90 mb-2">{verseData.subtitle}</p>
                                    <p className="opacity-80 text-xs">
                                        {isPanic ? 'ğŸ˜± ì«“ì•„ì˜¤ê³  ìˆì–´ìš”! ì–´ì„œ ì½ìœ¼ì„¸ìš”!' 
                                            : `${currentUser.name}ë‹˜, ì˜¤ëŠ˜ë„ í˜ë‚´ì„¸ìš”!`}
                                    </p>
                                </div>
                                <div className="p-6">
                                    {/* Markdown Renderer Applied */}
                                    <div className={`mb-8 min-h-[100px] ${verseData.loading ? 'animate-pulse bg-slate-100 rounded' : ''}`}>
                                        {verseData.loading ? '' : <MarkdownRenderer content={verseData.text} />}
                                    </div>
                                    
                                    <button onClick={handleRead} disabled={verseData.loading} className={`w-full text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 disabled:opacity-50 ${isPanic ? 'bg-red-600 shadow-red-200' : 'bg-slate-900 shadow-blue-200'}`}>
                                        <Icon name="book" size={18}/>
                                        <span>
                                            {hasReadToday 
                                                ? 'í•œ ì¥ ë” ì½ê¸° (ë¯¸ë¦¬ ì½ê¸°)' 
                                                : 'ì˜¤ëŠ˜ ë§ì”€ ì½ê¸° ì™„ë£Œ'
                                            }
                                        </span>
                                    </button>
                                    
                                    <div className="mt-4 bg-yellow-50 p-3 rounded-xl border border-yellow-100 text-center">
                                        <p className="text-xs text-yellow-700 font-bold">
                                            ğŸ’¡ ë°”ë¹ ì„œ ëª» ì½ìœ¼ì…¨ë‚˜ìš”? <br/>
                                            ì£¼ì¼ì— ë°€ë¦° ë§ì”€ì„ ëª°ì•„ì„œ ì½ì–´ë„ ê´œì°®ìŠµë‹ˆë‹¤! í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”!
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-slate-700 flex items-center">
                                        <Icon name="users" size={18} className="mr-2 text-indigo-500"/>
                                        {communityName} ì „ì²´ ìˆœìœ„
                                    </h3>
                                    <span className="text-[10px] bg-red-50 text-red-500 px-2 py-1 rounded-full font-bold">ë§¤ì¼ ë¦¬ì…‹!</span>
                                </div>
                                <div className="space-y-4 max-h-[250px] overflow-y-auto pr-2 scrollbar-hide">
                                    {subgroupRanking.map((group, idx) => {
                                        const isMyGroup = group.name === subgroupId;
                                        const percentage = group.rate; 
                                        return (
                                            <div key={idx} className={`relative ${isMyGroup ? 'bg-blue-50 p-2 rounded-lg -mx-2' : ''}`}>
                                                <div className="flex justify-between text-xs mb-1">
                                                    <span className={`font-bold ${isMyGroup ? 'text-blue-600' : 'text-slate-600'}`}>
                                                        {idx+1}ìœ„. {group.name} {isMyGroup && '(ìš°ë¦¬íŒ€)'}
                                                    </span>
                                                    <span className={`font-bold ${isMyGroup ? 'text-blue-600' : 'text-slate-400'}`}>{group.rate}%</span>
                                                </div>
                                                <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                                                    <div className={`h-full rounded-full transition-all duration-1000 ${isMyGroup ? 'bg-blue-500' : 'bg-slate-300'}`} style={{ width: `${percentage}%` }}></div>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
